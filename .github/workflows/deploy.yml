name: éƒ¨ç½²æ™ºèƒ½è¡¨æƒ…åŒ…æ¨èç³»ç»Ÿ

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  PYTHON_VERSION: '3.9'
  PROJECT_NAME: 'emoji-recommender'

jobs:
  deploy:
    name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: æ‰“åŒ…é¡¹ç›®æ–‡ä»¶
      run: |
        # åˆ›å»ºéƒ¨ç½²åŒ…ï¼ŒåªåŒ…å«å¿…è¦æ–‡ä»¶
        tar -czf deploy.tar.gz \
          --exclude='.git*' \
          --exclude='__pycache__' \
          --exclude='*.pyc' \
          --exclude='.pytest_cache' \
          --exclude='venv' \
          --exclude='logs' \
          --exclude='*.faiss' \
          --exclude='*.pkl' \
          --exclude='oss_emoji_metadata.json' \
          *.py requirements.txt *.md config_example.py env.template || true
    
    - name: ä¸Šä¼ ä»£ç åˆ°æœåŠ¡å™¨
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        password: ${{ secrets.PASSWORD }}
        port: ${{ secrets.PORT || 22 }}
        source: "deploy.tar.gz"
        target: "/tmp/"
    
    - name: éƒ¨ç½²åˆ°UbuntuæœåŠ¡å™¨
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        password: ${{ secrets.PASSWORD }}
        port: ${{ secrets.PORT || 22 }}
        timeout: 300s  # å¢åŠ è¶…æ—¶æ—¶é—´åˆ°5åˆ†é’Ÿ
        script: |
          set -e
          
          echo "ğŸš€ å¼€å§‹å¿«é€Ÿéƒ¨ç½²æ™ºèƒ½è¡¨æƒ…åŒ…æ¨èç³»ç»Ÿ..."
          
          # è®¾ç½®å˜é‡
          PROJECT_DIR="/opt/${{ env.PROJECT_NAME }}"
          SERVICE_NAME="${{ env.PROJECT_NAME }}"
          
          # å¿«é€Ÿæ£€æŸ¥ç³»ç»Ÿä¾èµ–ï¼ˆè·³è¿‡ä¸å¿…è¦çš„æ£€æŸ¥ï¼‰
          if ! command -v python3 &> /dev/null || ! python3 -m venv --help &> /dev/null; then
              echo "ğŸ“¦ å®‰è£…Pythonä¾èµ–..."
              export DEBIAN_FRONTEND=noninteractive
              sudo apt update -qq > /dev/null 2>&1
              sudo apt install -y -qq python3 python3-pip python3-venv python3-dev > /dev/null 2>&1
          else
              echo "âœ… Pythonç¯å¢ƒå·²å°±ç»ª"
          fi
          
          # åœæ­¢ç°æœ‰æœåŠ¡
          if systemctl is-active --quiet $SERVICE_NAME 2>/dev/null; then
              echo "â¹ï¸ åœæ­¢ç°æœ‰æœåŠ¡..."
              sudo systemctl stop $SERVICE_NAME
          fi
          
          # å¿«é€Ÿå¤‡ä»½ï¼ˆä»…ä¿ç•™ç¯å¢ƒæ–‡ä»¶ï¼‰
          if [ -f "$PROJECT_DIR/.env" ]; then
              echo "ğŸ“‚ å¤‡ä»½ç¯å¢ƒé…ç½®..."
              cp "$PROJECT_DIR/.env" "/tmp/.env.backup"
          fi
          
          # éƒ¨ç½²æ–°ä»£ç 
          echo "ğŸ“¥ éƒ¨ç½²æ–°ä»£ç ..."
          sudo rm -rf "$PROJECT_DIR"
          sudo mkdir -p "$PROJECT_DIR"
          sudo chown $USER:$USER "$PROJECT_DIR"
          cd "$PROJECT_DIR"
          tar -xzf /tmp/deploy.tar.gz
          sudo chown -R $USER:$USER "$PROJECT_DIR"
          rm -f /tmp/deploy.tar.gz
          
          # æ¢å¤ç¯å¢ƒé…ç½®
          if [ -f "/tmp/.env.backup" ]; then
              cp "/tmp/.env.backup" ".env"
              rm "/tmp/.env.backup"
              echo "âœ… æ¢å¤å·²å¤‡ä»½çš„ç¯å¢ƒé…ç½®"
          elif [ ! -f ".env" ]; then
              if [ -f "env.template" ]; then
                  cp "env.template" ".env"
                  echo "ğŸ“ åˆ›å»ºåˆå§‹ç¯å¢ƒé…ç½®æ–‡ä»¶ï¼ˆä½¿ç”¨æ¨¡æ¿ï¼‰"
              else
                  echo "ğŸ“ åˆ›å»ºåˆå§‹ç¯å¢ƒé…ç½®æ–‡ä»¶"
                  echo "# æ™ºèƒ½è¡¨æƒ…åŒ…æ¨èç³»ç»Ÿç¯å¢ƒå˜é‡é…ç½®" > .env
                  echo "# OSSè®¤è¯é…ç½®ï¼ˆå¦‚æœä¸ä½¿ç”¨ECS RAM Roleï¼‰" >> .env
                  echo "OSS_ACCESS_KEY_ID=your-access-key-id" >> .env
                  echo "OSS_ACCESS_KEY_SECRET=your-access-key-secret" >> .env
                  echo "OSS_USE_ECS_RAM_ROLE=false" >> .env
                  echo "# APIè®¤è¯é…ç½®" >> .env
                  echo "API_USERNAME=emoji_user" >> .env
                  echo "API_PASSWORD=emoji_pass_2025" >> .env
              fi
          fi
          
          # æ™ºèƒ½è™šæ‹Ÿç¯å¢ƒå¤„ç†
          echo "ğŸ è®¾ç½®è™šæ‹Ÿç¯å¢ƒ..."
          if [ ! -d "venv" ]; then
              python3 -m venv venv
          fi
          source venv/bin/activate
          
          # ä¼˜åŒ–çš„ä¾èµ–å®‰è£…
          echo "ğŸ“š å®‰è£…ä¾èµ–ï¼ˆä¼˜åŒ–æ¨¡å¼ï¼‰..."
          # ä½¿ç”¨pipç¼“å­˜å’Œå¹¶è¡Œå®‰è£…åŠ é€Ÿ
          pip install --upgrade pip --quiet
          pip install --no-cache-dir -r requirements.txt --quiet
          pip install gunicorn --quiet
          
          # åˆ›å»ºæ—¥å¿—ç›®å½•
          mkdir -p logs
          
          # åˆ›å»ºsystemdæœåŠ¡ï¼ˆä»…åœ¨ä¸å­˜åœ¨æ—¶ï¼‰
          if [ ! -f "/etc/systemd/system/$SERVICE_NAME.service" ]; then
              echo "ğŸ”§ åˆ›å»ºsystemdæœåŠ¡..."
              sudo tee /etc/systemd/system/$SERVICE_NAME.service > /dev/null <<EOF
          [Unit]
          Description=Intelligent Emoji Recommendation System
          After=network.target
          
          [Service]
          Type=simple
          User=$USER
          Group=$USER
          WorkingDirectory=$PROJECT_DIR
          Environment=PATH=$PROJECT_DIR/venv/bin
          ExecStart=$PROJECT_DIR/venv/bin/gunicorn -w 4 -k uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000 oss_api_server:app
          ExecReload=/bin/kill -s HUP \$MAINPID
          Restart=always
          RestartSec=3
          
          [Install]
          WantedBy=multi-user.target
          EOF
              sudo systemctl daemon-reload
              sudo systemctl enable $SERVICE_NAME
          fi
          
          # å¯åŠ¨æœåŠ¡
          echo "ğŸ”„ å¯åŠ¨æœåŠ¡..."
          sudo systemctl start $SERVICE_NAME
          
          # å¿«é€Ÿå¥åº·æ£€æŸ¥
          echo "ğŸ¥ å¥åº·æ£€æŸ¥..."
          sleep 5
          for i in {1..5}; do
              if curl -s http://localhost:8000/health > /dev/null 2>&1; then
                  echo "âœ… æœåŠ¡å¯åŠ¨æˆåŠŸ"
                  
                  # é¢å¤–æ£€æŸ¥APIæ˜¯å¦æ­£å¸¸
                  if curl -s http://localhost:8000/ > /dev/null 2>&1; then
                      echo "âœ… APIæœåŠ¡æ­£å¸¸å“åº”"
                  else
                      echo "âš ï¸  APIæœåŠ¡å¯èƒ½éœ€è¦é…ç½®"
                  fi
                  break
              elif [ $i -eq 5 ]; then
                  echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼š"
                  sudo journalctl -u $SERVICE_NAME --no-pager -l -n 10
                  echo ""
                  echo "ğŸ” å¯èƒ½çš„é—®é¢˜ï¼š"
                  echo "   1. OSSé…ç½®æœªæ­£ç¡®è®¾ç½®"
                  echo "   2. Pythonä¾èµ–å®‰è£…å¤±è´¥"
                  echo "   3. ç«¯å£8000è¢«å ç”¨"
                  exit 1
              else
                  echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨... ($i/5)"
                  sleep 3
              fi
          done
          
          # è·å–æœåŠ¡å™¨IP
          SERVER_IP=$(curl -s -4 --max-time 5 ifconfig.me 2>/dev/null || hostname -I | awk '{print $1}')
          
          echo ""
          echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
          echo "ğŸ“ æœåŠ¡åœ°å€: http://$SERVER_IP:8000"
          echo "ğŸ“š APIæ–‡æ¡£: http://$SERVER_IP:8000/docs"
          echo "ğŸ¥ å¥åº·æ£€æŸ¥: http://$SERVER_IP:8000/health"
          echo ""
          echo "ğŸ”— APIç«¯ç‚¹ç¤ºä¾‹:"
          echo "   è¡¨æƒ…åŒ…æ¨è: curl -X POST http://$SERVER_IP:8000/recommend -H 'Content-Type: application/json' -d '{\"input\":\"å¼€å¿ƒ\"}'"
          echo "   æœåŠ¡çŠ¶æ€: curl http://$SERVER_IP:8000/status"
          echo "   é…ç½®ä¿¡æ¯: curl http://$SERVER_IP:8000/config"
          echo ""
          echo "ğŸ“‹ ç®¡ç†å‘½ä»¤:"
          echo "   çŠ¶æ€: sudo systemctl status $SERVICE_NAME"
          echo "   æ—¥å¿—: sudo journalctl -u $SERVICE_NAME -f"
          echo "   é‡å¯: sudo systemctl restart $SERVICE_NAME"
          echo ""
          echo "âš ï¸ é‡è¦æé†’:"
          echo "   1. è¯·ç¼–è¾‘ $PROJECT_DIR/config.py æ–‡ä»¶é…ç½®OSSå‚æ•°"
          echo "   2. é…ç½®å®Œæˆåè¿è¡Œ: sudo systemctl restart $SERVICE_NAME"
          echo "   3. å»ºè®®é…ç½®Nginxåå‘ä»£ç†ç”¨äºç”Ÿäº§ç¯å¢ƒ"
          echo "   4. ç¡®ä¿OSS Bucketä¸­å·²ä¸Šä¼ è¡¨æƒ…åŒ…æ–‡ä»¶"
          echo "   5. è®¿é—® http://$SERVER_IP:8000/docs æŸ¥çœ‹APIæ–‡æ¡£"